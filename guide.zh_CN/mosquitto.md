# Perfect-Mosquitto 

è¯¥é¡¹ç›®æ˜¯åŸºäºŽ MQTT å®¢æˆ·ç«¯å‡½æ•°åº“ libmosquitto ä¸Šçš„ Swift ç±»å°è£…ã€‚

è¯¥è½¯ä»¶ä½¿ç”¨SPMè¿›è¡Œç¼–è¯‘å’Œæµ‹è¯•ï¼Œæœ¬è½¯ä»¶ä¹Ÿæ˜¯[Perfect](https://github.com/PerfectlySoft/Perfect)é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥ä½œä¸ºæœåŠ¡å™¨ç»„ä»¶ç‹¬ç«‹è¿è¡Œã€‚

è¯·ç¡®ä¿æ‚¨å·²ç»å®‰è£…å¹¶æ¿€æ´»äº†æœ€æ–°ç‰ˆæœ¬çš„ Swift 4.0 tool chain å·¥å…·é“¾ã€‚

## OS X ç¼–è¯‘è¯´æ˜Ž

### Homebrew ç»„ä»¶å®‰è£…

æœ¬é¡¹ç›®ä¾èµ–äºŽ mosquitto Cè¯­è¨€å‡½æ•°åº“ã€‚ä¸ºäº†å®žçŽ°åœ¨è‹¹æžœæ“ä½œç³»ç»Ÿä¸Šç¼–è¯‘ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹`brew`å‘½ä»¤ï¼š

```
$ brew install mosquitto
```

### PC é…ç½®æ–‡ä»¶

æœ¬é¡¹ç›®åŒæ—¶éœ€è¦æ‰‹å·¥ç¼–è¾‘é…ç½®æ–‡ä»¶`/usr/local/lib/pkgconfig/mosquitto.pc`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
Name: mosquitto
Description: Mosquitto Client Library
Version: 1.4.11
Requires:
Libs: -L/usr/local/lib -lmosquitto
Cflags: -I/usr/local/include

```

å¹¶ä¸”è¯·ç¡®å®šå½“å‰ç»ˆç«¯çŽ¯å¢ƒä¸­åŒ…æ‹¬å˜é‡ `$PKG_CONFIG_PATH`:

```
$ export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:/usr/lib/pkgconfig"
```

## Linux ç¼–è¯‘è¯´æ˜Ž

æœ¬é¡¹ç›®éœ€è¦ Ubuntu 16.04 é™æ€å‡½æ•°åº“ `libmosquitto-dev`:

```
$ apt-get libmosquitto-dev
```


## å¿«é€Ÿä¸Šæ‰‹

### å‡½æ•°åº“å¼€æ”¾ä¸Žå…³é—­

åœ¨ä½¿ç”¨ä»»ä½•Perfect Mosquittoå‡½æ•°ä¹‹å‰ï¼Œè¯·åŠ¡å¿…è°ƒç”¨ `Mosquitto.OpenLibrary()`æ‰“å¼€å‡½æ•°åº“ã€‚åŒæ ·ï¼Œè¯·åœ¨ç¨‹åºé€€å‡ºæ—¶å…³é—­å‡½æ•°åº“ï¼Œå³è°ƒç”¨`Mosquitto.CloseLibrary()`é™æ€æ–¹æ³•ã€‚

*æ³¨æ„* å‡½æ•°åº“å¼€æ”¾ä¸Žå…³é—­æ“ä½œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› æ­¤è¯·åœ¨æ‰§è¡Œå¤šçº¿ç¨‹ä»»åŠ¡ä¹‹å‰è¿›è¡Œæ“ä½œã€‚

### åˆå§‹åŒ–ä¸€ä¸ª Mosquitto ç±»å®žä¾‹

åˆå§‹åŒ– Mosquitto ç±»æ—¶ï¼Œå¯ä»¥å¸¦å‚æ•°ä¹Ÿå¯ä»¥ä¸å¸¦ä»»ä½•å‚æ•°ã€‚æœ€ç®€å•çš„æ–¹æ³•å¦‚ä¸‹ï¼š

``` swift
let m = Mosquitto()
```

æ„å‘³ç€è‡ªåŠ¨ä¸ºè¯¥å®¢æˆ·ç«¯å¯¹è±¡åˆ†é…ä¸€ä¸ªéšæœºåºåˆ—å·ï¼Œè€Œä¸”åœ¨æ–­å¼€è¿žæŽ¥æ—¶æ‰€æœ‰æ¶ˆæ¯å’Œè®¢é˜…éƒ½ä¼šè¢«è‡ªåŠ¨æ¸…é™¤ã€‚

å½“ç„¶æ‚¨ä¹Ÿå¯ä»¥æ‰‹å·¥ä¸ºå®¢æˆ·ç«¯åˆ†é…ä¸€ä¸ªåºåˆ—å·ï¼Œè¿™ç§æƒ…å†µä¸‹åœ¨æ–­ç‚¹ç»­ä¼ æ—¶ä¼šéžå¸¸æœ‰ç”¨ï¼š

``` swift
let mosquitto = Mosquitto(id: "myInstanceId", cleanSession: false)
```

### è¿žæŽ¥åˆ°æ¶ˆæ¯æŽ®å®¢

æ¶ˆæ¯æŽ®å®¢å°±æ˜¯ç”¨äºŽä¸­è½¬ç»´æŠ¤æ¶ˆæ¯çš„æœåŠ¡å™¨ï¼Œè¿™é‡Œçš„æ¶ˆæ¯æœåŠ¡å™¨æŒ‡çš„æ˜¯ç¬¦åˆMQTTåè®®çš„æœåŠ¡å™¨â€”â€”è´Ÿè´£ä»Žæ¶ˆæ¯æºæŽ¥æ”¶æ¶ˆæ¯ï¼Œå¹¶ä¸”åˆ†å‘åˆ°æ‰€æœ‰è®¢é˜…è€…åŽ»ã€‚

è™½ç„¶è¿žæŽ¥æ–¹æ³•`connect()`å¯ä»¥å¼‚æ­¥æ“ä½œã€ç»´æŒé•¿è¿žæŽ¥æˆ–ç»‘å®šåˆ°ç‰¹å®šç½‘å¡åœ°å€ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸‹é¢çš„æ–¹æ³•æ˜¯æœ€ç®€æ˜Žæ‰¼è¦çš„ï¼šåªéœ€è¦æä¾›æœåŠ¡å™¨åœ°å€å’Œç«¯å£ï¼ˆé€šå¸¸æ˜¯1883ï¼‰å³å¯ï¼š

``` swift
try moosquitto.connect(host: "mybroker.com", port: 1883)
```

å°½ç®¡å½“ä¾‹ç¨‹ç»“æŸæ—¶ Swift ä¼šä»¥æ¸…ç†å¯¹è±¡çš„æ–¹å¼æ–­å¼€æœåŠ¡å™¨è¿žæŽ¥ï¼Œä½†æˆ‘ä»¬ä»ç„¶æŽ¨èæ˜¾å¼è°ƒç”¨ `disconnect()`æ–¹æ³•æ–­å¼€æœåŠ¡å™¨è¿žæŽ¥ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒåŒä¸€ä¸ªä¾‹ç¨‹åœ¨æ–­å¼€è¿žæŽ¥åŽï¼Œè¿˜å¯ä»¥ç”¨ `reconnect()`æ–¹æ³•é‡æ–°è¿žå›žåˆ°æœåŠ¡å™¨ã€‚

### çº¿ç¨‹æ¨¡åž‹

#### æœåŠ¡çº¿ç¨‹çš„å¯åŠ¨åœæ­¢
Perfect Mosquitto æœ‰ä¸¤ç§çº¿ç¨‹è°ƒåº¦æ–¹å¼ã€‚å®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨`start()`æ–¹æ³•å¯åŠ¨ä¸€ä¸ªåŽå°çº¿ç¨‹ç”¨äºŽå¤„ç†æ¶ˆæ¯å‘å¸ƒå’ŒæŽ¥æ”¶ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸»çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡žï¼Œå¹¶ä¸”å¯ä»¥éšæ—¶è°ƒç”¨`stop()`æ–¹æ³•ç»“æŸåŽå°æœåŠ¡çº¿ç¨‹è¿è¡Œï¼š

``` swift
// å¯åŠ¨åŽå°çº¿ç¨‹ç”¨äºŽå¤„ç†æ¶ˆæ¯ï¼Œä¸ä¼šé˜»å¡žä¸»çº¿ç¨‹ï¼Œè°ƒç”¨åŽç«‹åˆ»è¿”å›žã€‚
try mosquitto.start()

// éšåŽæ‚¨å¯ä»¥åœ¨ä¸»çº¿ç¨‹å†…æ‰§è¡Œä»»æ„æ“ä½œï¼Œæ¯”å¦‚æ¶ˆæ¯å‘é€ï¼›æ¶ˆæ¯æŽ¥æ”¶ä¼šä»¥å›žè°ƒæ–¹å¼è¿›è¡Œã€‚

// å¦‚æžœä¸éœ€è¦ç»§ç»­å¤„ç†æ¶ˆæ¯ï¼Œå¯ä»¥è°ƒç”¨ä»¥ä¸‹å‡½æ•°åœæ­¢æœåŠ¡çº¿ç¨‹çš„è¿è¡Œ
try mosquitto.stop()
```

#### ç­‰å¾…æ¶ˆæ¯äº‹ä»¶

ä¸åŒäºŽä¸Šè¿°æ–¹æ³•ï¼Œæ‚¨è¿˜å¯ä»¥åœ¨ä¸»çº¿ç¨‹å†…å¤„ç†æ‰€æœ‰äº‹ä»¶ï¼Œåªä¸è¿‡éœ€è¦é¢‘ç¹è°ƒç”¨`wait()`å‡½æ•°ï¼Œå®žçŽ°æ¶ˆæ¯è½®è¯¢ï¼š

``` swift
// ç­‰å¾…ä¸€ä¸ªå¾ˆçŸ­çš„æ—¶é—´ï¼ˆæœ€å°çš„æ—¶é—´ç‰‡æ®µï¼‰
// æ­¤æ—¶ï¼Œmosquitto ä¼šåˆ©ç”¨è¿™ä¸ªæ—¶é—´ç‰‡æ®µè¿›è¡Œæ¶ˆæ¯æ”¶å‘å¤„ç†
try mosquitto.wait(0)
```

è¯¥æ–¹æ³•å”¯ä¸€çš„å‚æ•°å°±æ˜¯ç­‰å¾…çš„æ—¶é—´ç‰‡æ¯«ç§’æ•°ã€‚0ä»£è¡¨æœ€å°æ—¶é—´ç‰‡ï¼ˆç”±ç³»ç»Ÿå†³å®šï¼‰ï¼Œè´Ÿæ•°åˆ™è¢«è§†ä¸º1ç§’é’Ÿï¼ˆ1000æ¯«ç§’ï¼‰ã€‚

âš ï¸ *æ³¨æ„* âš ï¸ *ä¸¤ç§çº¿ç¨‹æ¨¡åž‹åŽå° `start()`/`stop()` å’Œè½®è¯¢ `wait()`ä¸èƒ½æ··ç”¨ï¼*


### å‘é€æ¶ˆæ¯

ä¸€æ—¦è¿žæŽ¥åˆ°æœåŠ¡å™¨ï¼Œå¯ä»¥éšæ—¶å‘é€æ¶ˆæ¯ï¼š

``` swift
var msg = Mosquitto.Message()
msg.id = 100 // æ¶ˆæ¯ç¼–ç ï¼Œè¯·è‡ªè¡Œå®šä¹‰
msg.topic = "publish/test" // æ¶ˆæ¯ä¸»é¢˜ï¼Œæ ¼å¼ç”±MQTTå†³å®š
msg.string = "å‘é€æµ‹è¯• ðŸ‡¨ðŸ‡³ðŸ‡¨ðŸ‡¦"

let mid = try mosquitto.publish(message: msg)
```

å¦‚ä¸Šè¿°ä¾‹å­ï¼Œé¦–å…ˆæ˜¯åˆ›å»ºä¸€ä¸ªç©ºæ¶ˆæ¯ç»“æž„ï¼Œç„¶åŽå¯ä»¥æŒ‡å®šæ¶ˆæ¯ç¼–å·ã€æ¶ˆæ¯ä¸»é¢˜å’Œæ¶ˆæ¯å†…å®¹ï¼›éšåŽè°ƒç”¨`publish()`æ–¹æ³•æŠŠå‡†å¤‡å¥½çš„æ¶ˆæ¯å‘å‡ºåŽ»ï¼›è¯¥å‡½æ•°å°†è¿”å›žå®žé™…çš„æ¶ˆæ¯ç¼–å·ã€‚

*æ³¨æ„* æ¶ˆæ¯å†…å®¹ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„ï¼š
``` swift
// å‘é€ä¸€ä¸ªäºŒè¿›åˆ¶ [Int8] å­—èŠ‚æ•°ç»„
msg.payload = [40, 41, 42, 43, 44, 45]
```

ä¸€æ—¦å‘å¸ƒï¼Œè¯·è°ƒç”¨ `start()`åŽå°çº¿ç¨‹å¤„ç†å™¨æˆ–è€… `wait()`è½®è¯¢è¿›è¡Œå®žé™…æ¶ˆæ¯å‘å¸ƒï¼Œå‚è€ƒå‰æ–‡çš„æ¶ˆæ¯æ¨¡åž‹ã€‚

### æ¶ˆæ¯çš„è®¢é˜…å’ŒæŽ¥æ”¶

åœ¨Perfect Mosquittoå‡½æ•°åº“ä¸­æŽ¥æ”¶ MQTT æ¶ˆæ¯çš„å”¯ä¸€æ–¹æ³•æ˜¯è‡ªå®šä¹‰äº‹ä»¶å›žè°ƒï¼š

``` swift

mosquitto.OnMessage = { msg in

	// æ‰“å°æ¶ˆæ¯ç¼–å·
	print(msg.id)

	// æ‰“å°æ¶ˆæ¯ä¸»é¢˜
	print(msg.topic)

	// æ‰“å°æ¶ˆæ¯å†…å®¹
	print(msg.string)

	// ä»¥äºŒè¿›åˆ¶å­—èŠ‚æµçš„å½¢å¼è¾“å‡ºæ¶ˆæ¯å†…å®¹
	print(msg.payload)
}//end on Message

```

ä¸€æ—¦è®¾ç½®å¥½äº‹ä»¶å›žè°ƒå‡½æ•°ï¼Œå¯ä»¥è°ƒç”¨ `subscribe()`å®Œæˆç‰¹å®šä¸»é¢˜æ¶ˆæ¯çš„è®¢é˜…ï¼š

``` swift
try mosquitto.subscribe(topic: "publish/test")
```

ä¸€æ—¦è®¢é˜…ï¼Œè¯·è°ƒç”¨ `start()`åŽå°çº¿ç¨‹å¤„ç†å™¨æˆ–è€… `wait()`è½®è¯¢è¿›è¡Œå®žé™…çš„æ¶ˆæ¯æŽ¥æ”¶ï¼Œå‚è€ƒå‰æ–‡çš„æ¶ˆæ¯æ¨¡åž‹ã€‚

## å…¶ä»–å‡½æ•°å‚è€ƒ

é™¤ä¸Šè¿°ç®€è¦è¯´æ˜Žä¹‹å¤–ï¼ŒPerfect Mosquitto è¿˜æä¾›äº†å®Œæ•´çš„å‡½æ•°åº“ï¼Œè¯·å‚è€ƒé¡¹ç›®çš„å‡½æ•°æ‰‹å†Œã€‚

### äº‹ä»¶å›žè°ƒ

å¦‚æžœæœ‰éœ€è¦ï¼Œè¯·ä¸ºæ‚¨çš„mosquittoå¯¹è±¡è‡ªè¡Œè®¾ç½®ä»¥ä¸‹å›žè°ƒå‡½æ•°ï¼ˆé—­åŒ…ï¼‰ï¼š

API|å‚æ•°|è¯´æ˜Ž
---|----------|-----------
`OnConnect { status in }` | `ConnectionStatus` | è¿žæŽ¥åˆ°æœåŠ¡å™¨æ—¶è§¦å‘
`OnDisconnected { status in }` | `ConnectionStatus` | è¿žæŽ¥æ–­å¼€æ—¶å‡ºå‘
`OnPublish { msg in }` | `Message` | æ¶ˆæ¯å‘é€åŽè§¦å‘
`OnMessage { msg in }` | `Message` | æ¶ˆæ¯åˆ°è¾¾åŽè§¦å‘
`OnSubscribe { id, qos in }` | `(Int32, [Int32])` | æ¶ˆæ¯è®¢é˜…åŽè§¦å‘
`OnUnsubscribe { id in }` | `Int32` (message id) | æ¶ˆæ¯å–æ¶ˆè®¢é˜…æ—¶å‡ºå‘
`OnLog { level, content in }` | `(LogLevel, String)` | å¦‚æžœæœ‰æ—¥å¿—ç”Ÿæˆæ—¶å‡ºå‘

### TLS é…ç½®

- è®¾ç½® TLS è¯ä¹¦ï¼š `func setTLS(caFile: String, caPath: String, certFile: String? = nil, keyFile: String? = nil, keyPass: String? = nil) throws`

- è®¾ç½® TLS éªŒè¯æ–¹æ³•ï¼š `func setTLS(verify: SSLVerify = .PEER, version: String? = nil, ciphers: String? = nil) throws`

- è®¾ç½® TLS é¢„åˆ†é…é’¥åŒ™ï¼š `func setTLS(psk: String, identity: String, ciphers: String? = nil) throws`

### å…¶ä»–å‡½æ•°

- é…ç½®æœŸæœ›ï¼š `func setConfigWill(message: Message?) throws`

- é…ç½®ç”¨æˆ·åå¯†ç ï¼š `func login(username: String? = nil, password: String? = nil) throws`

- é…ç½®æ¶ˆæ¯å‘é€å¤±è´¥æ—¶é‡è¯•ç­‰å¾…æ—¶é—´ `func setMessageRetry(max: UInt32 = 20)`

- è®¾ç½®æ’é˜Ÿæ¶ˆæ¯QoSä¼˜å…ˆçº§ï¼š `func setInflightMessages(max: UInt32 = 20) throws`

- è®¾ç½®å®¢æˆ·ç«¯æ–­å¼€æ—¶é‡è¿žç­‰å¾…æ—¶é—´ï¼š `func reconnectSetDelay(delay: UInt32 = 2, delayMax: UInt32 = 10, backOff: Bool = false) throws`

- æ–­çº¿é‡è¿žï¼š`func reconnect(_ asynchronous: Bool = true) throws`

- å½“å‰å®¢æˆ·ç«¯ä¾‹ç¨‹å†…å®¹é‡å¯ `func reset(id: String? = nil, cleanSession: Bool = true) throws`

- è®¾ç½® MQTT ç‰ˆæœ¬ï¼š `func setClientOption(_ version: MQTTVersion = .V31, value: UnsafeMutableRawPointer) throws`

- è§£é‡Šé”™è¯¯ä¿¡æ¯ï¼ˆè‹±è¯­ï¼‰`static func Explain(_ fault: Exception) -> String`
 
